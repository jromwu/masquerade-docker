services:
  gateway:
    build: gateway
    command: sh -c "./configure.sh; echo hello world; tcpdump -i eth1 -n -w /pcap/gateway-$(date +%Y-%m-%d-%H-%M-%S).pcap; tail -f /dev/null"
    volumes:
      - ./pcap:/pcap
    environment:
      - SOCKS_HOST=172.17.0.1
    cap_add:
      - NET_ADMIN
    networks:
      - external # eth0
      - internal # eth1

  client:
    build: client
    command: sh -c "./configure.sh; echo hello world; curl example.com; python3 ./test_selenium_form.py; tail -f /dev/null"
    volumes:
      - ./selenium/captures:/usr/captures
    environment:
      - CHROMIUM_DRIVER_ADDR=http://chromium:4444
      - FIREFOX_DRIVER_ADDR=http://firefox:4444
      - CAPTURES_DIR=/usr/captures
    cap_add:
      - NET_ADMIN
    networks:
      - internal
    depends_on:
      gateway:
        condition: service_started
      chromium:
        condition: service_healthy
      # firefox:
      #   condition: service_healthy

  chromium:
    build: chromium
    command: sh -c "./configure.sh; echo hello world; curl example.com; /opt/bin/entry_point.sh"
    ports:
      - "4444:4444" # for development
    volumes:
      - /dev/shm:/dev/shm
    cap_add:
      - NET_ADMIN
    networks:
      - internal
    depends_on:
      - gateway
    shm_size: '2gb'
    healthcheck:
        test: curl -f http://localhost:4444 || exit 1
        interval: 10s
        timeout: 2s
        retries: 5
        start_period: 20s

  # firefox:
  #   build: firefox
  #   command: sh -c "./configure.sh; echo hello world; curl example.com; /opt/bin/entry_point.sh"
  #   ports:
  #     - "4445:4444" # for development
  #   volumes:
  #     - /dev/shm:/dev/shm
  #   cap_add:
  #     - NET_ADMIN
  #   networks:
  #     - internal
  #   depends_on:
  #     - gateway
  #   shm_size: '2gb'
  #   healthcheck:
  #       test: curl -f http://localhost:4444 || exit 1
  #       interval: 10s
  #       timeout: 2s
  #       retries: 5
  #       start_period: 20s



networks:
  external:
    driver: bridge
  internal:
    driver: bridge
